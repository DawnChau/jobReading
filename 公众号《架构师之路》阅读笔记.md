## 公众号《架构师之路》阅读笔记

### 《究竟啥才是互联网架构“高可用”》

- https://mp.weixin.qq.com/s/p0LsxT-JUS7zYg23M7nupQ

- 高可用主要指 “时间”
- 单点是高可用的大敌
- 保证高可用的核心是：冗余（集群）
- 避免人工恢复故障：自动故障转移
- 架构的每一层都要做 冗余 + 自动故障转移
  - 反向代理层：以nginx为例：有两台nginx，一台对线上提供服务，另一台冗余以保证高可用，常见的实践是keepalived存活探测，相同virtual IP提供服务。当nginx挂了的时候，keepalived能够探测到，会自动的进行故障转移，将流量自动迁移到shadow-nginx，由于使用的是相同的virtual IP，这个切换过程对调用方是透明的。
  - 站点层：假设反向代理层是`nginx`，nginx.conf里能够配置多个web后端，并且nginx能够探测到多个后端的存活性。当web-server挂了的时候，nginx能够探测到，会自动的进行故障转移，将流量自动迁移到其他的web-server，整个过程由nginx自动完成，对调用方是透明的。
  - 服务层：`“服务连接池”`会建立与下游服务多个连接，每次请求会“随机”选取连接来访问下游服务。当service挂了的时候，service-connection-pool能够探测到，会自动的进行故障转移，将流量自动迁移到其他的service，整个过程由连接池自动完成，对调用方是透明的（所以说RPC-client中的服务连接池是很重要的基础组件）。
  - 缓存层：
    - 利用客户端的封装，service对cache进行双读或者双写。缓存层也可以通过支持主从同步的缓存集群来解决缓存层的高可用问题。以redis为例，redis天然支持主从同步，redis官方也有sentinel哨兵机制，来做redis的存活性检测。当redis主挂了的时候，sentinel能够探测到，会通知调用方访问新的redis，整个过程由sentinel和redis集群配合完成，对调用方是透明的。
    - 将kv缓存封装成服务集群，上游设置一个代理（代理可以用集群冗余的方式保证高可用），代理的后端根据缓存访问的key水平切分成若干个实例，每个实例的访问并不做高可用。缓存实例挂了屏蔽：当有水平切分的实例挂掉时，代理层直接返回cache miss，此时缓存挂掉对调用方也是透明的。key水平切分实例减少，不建议做re-hash，这样容易引发缓存数据的不一致。
  - 数据库层：大部分互联网技术，数据库层都用了“主从同步，读写分离”架构，所以数据库层的高可用，又分为“读库高可用”与“写库高可用”两类。写master，读slave
    - 读的高可用：既然冗余了读库，一般来说就至少有2个从库，“数据库连接池”会建立与读库多个连接，每次请求会路由到这些读库。当读库挂了的时候，db-connection-pool能够探测到，会自动的进行故障转移，将流量自动迁移到其他的读库，整个过程由连接池自动完成，对调用方是透明的（所以说DAO中的数据库连接池是很重要的基础组件）。
    - 写的高可用：以mysql为例，可以设置两个mysql双主同步，一台对线上提供服务，另一台冗余以保证高可用，常见的实践是keepalived存活探测，相同virtual IP提供服务。自动故障转移：当写库挂了的时候，keepalived能够探测到，会自动的进行故障转移，将流量自动迁移到shadow-db-master，由于使用的是相同的virtual IP，这个切换过程对调用方是透明的

### 《怎么理解分布式、高并发、多线程？》

- https://mp.weixin.qq.com/s/k1Fz0NCN8KyV3VHF0nSGuA
- 分布式
  - 水平扩展：当一台机器扛不住流量时，就通过添加机器的方式，将流量平分到所有服务器上，所有机器都可以提供相当的服务
  - 垂直扩展：前端有多种查询需求时，一台机器扛不住，可以将不同的需求分发到不同的机器上，比如A机器处理余票查询的请求，B机器处理支付的请求。
- 高并发：
  - 高并发可以通过`分布式`技术去解决，将并发流量分到不同的物理服务器上。但除此之外，还可以有很多其他优化手段：比如使用`缓存系统`，将所有的，`静态内容放到CDN等`；还可以使用`多线程`技术将一台服务器的服务能力最大化。
    - 服务并发低时候写数据库，并发高时候通过消息队列写缓存。缓存定期持久化到数据库
    - 服务读数据直接从缓存读

### 《一次彻底搞透协议设计》

- https://mp.weixin.qq.com/s/wr7chJqpOBbv3M3JXD1wXg
- 分层：
  - 应用层
    - 文本（HTTP）
      - 可读性好，可扩展性好，解析效率不高，对二进制不友好
    - 二进制（IP）
      - 定长包头，可扩展变长包体，每个字段有固定的含义
      - 可读性差，难以调试。扩展性不好。解析效率高。支持二进制流
      - Protobuf 是常见的变长包体协议
    - 流式XML（XMPP）
      - 可读性好，扩展性好
      - 解析代价超高，DOM树
      - 有效数据传输效率低
      - 对二进制不友好
  - 安全层
    - SSL
    - 自己实现
      - 一人一密（uid，手机号，qq号等）
      - 一次一密
  - 传输层
    - TCP
    - epoll 可以抗单机几十万连接