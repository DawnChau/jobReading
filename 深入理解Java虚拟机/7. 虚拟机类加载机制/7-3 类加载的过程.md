## 7-3 类加载的过程

### 7-3-1 加载

- 加载过程虚拟机做的三件事
  - 通过类的全限定名来获取此类的二进制字节流
  - 将字节流的静态存储结构转化为方法区的运行时数据结构
  - 在内存中生成代表这个类的Class对象，作为方法区这个类的各种数据的访问入口。
- 数组本身不通过类加载器创建，由java虚拟机直接创建
- 引用类型的数组，数组在加载该引用类的类加载去的名称空间上被标识
- 如果不是引用类型的数组，数组与引导类加载器相关联
- 数组类的可见性与组件类型的可见性一致，如果组件类型不是引用类型，则数组类的可见性为public
- Class类对象虽然是对象，但是存放在方法区中
- 加载阶段与连接阶段中的验证阶段是交叉进行的

### 7-3-2 验证

- 文件格式验证：基于字节流
- 元数据验证：对类的元数据信息进行语义检查
- 字节码验证：保证被校验类的方法在运行时不会做出危害虚拟机的行为
  - 复杂性高，因此在Code的属性表里增加StackMapTable，只要检查StackMapTable属性中的记录是否合法即可，这样将字节码验证的类型推到转变为类型检查。
- 符号引用验证

### 7-3-3 准备

- 进行内存分配的仅包括类变量
- 全部初始化为零值
- 特殊情况：如果类字段的字段属性表中存在ConstantValue，那么初始化为该值（加final的）

### 7-3-4 解析

- 是将常量池中的符号引用替换为直接引用的过程
  - 符号引用：引用的目标并不一定被加载到内存中
  - 直接引用：目标已经在内存中
- 除了incokedynamic指令以外，虚拟机实现可以对第一次解析的结果进行缓存，从而避免重复解析。
  - 字段解析：如果接口和父类中有同名字段，则编译器拒绝编译
  - 接口方法解析：由于接口中所有的方法默认都是public的，所以不存在访问权限问题

### 7-3-5 初始化

- `<clinit>` 是编译器自动收集类变量的赋值动作和静态语句块的语句合并产生的。
- 静态语句块只能访问到定义在静态语句块之前的变量
- `<clinit>` 不需要显示的调用父类构造器，虚拟机会保证父类的`<clinit>` 方法已经执行完毕，因此在虚拟机中第一个被执行`<clinit>`方法的类肯定是java.lang.Object
- 父类的静态语句块要优先于子类静态变量的赋值操作
- 如果接口中没有静态变量的赋值操作，则不会为其生成`<clinit>`
- 执行接口的`<clinit>`不需要先执行父接口的方法，只有当父接口中定义的变量使用时，父接口才会初始化，另外，接口的实现类在初始化时，也一样不会执行接口的`<clinit>` 方法。

